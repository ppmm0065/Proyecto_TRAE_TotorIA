{% extends 'base.html' %}

{% block title %}
    {{ page_title|default('Reporte 360') }} - {{ nombre_entidad }}
{% endblock %}

{% block panel_left_content %}
    <h2 class="text-xl font-semibold text-slate-800 mb-2">Reporte 360</h2>
    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-6">
        <p class="text-sm text-slate-600">Tipo de Entidad:</p>
        <p class="font-semibold text-indigo-700 break-words capitalize">{{ tipo_entidad }}</p>
        <p class="text-sm text-slate-600 mt-2">Nombre Entidad:</p>
        <p class="font-semibold text-indigo-700 break-words">{{ nombre_entidad }}</p>
        <p class="text-sm text-slate-600 mt-2">Archivo Origen:</p>
        <p class="font-semibold text-indigo-700 break-words">{{ filename }}</p>
        {% if reporte_360_id %}
        <p class="text-sm text-slate-600 mt-2">ID Reporte:</p>
        <p class="font-semibold text-indigo-700 break-words">#{{ reporte_360_id }}</p>
        {% endif %}
    </div>

    <hr class="my-6 border-slate-300">

    <h3 class="text-md font-semibold text-slate-700 mb-3">Acciones</h3>
    <ul class="space-y-2 text-sm">
        <li>
            <a href="{{ url_for('main.detalle_entidad', tipo=tipo_entidad, valor_codificado=nombre_entidad) }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2 w-4 text-center"></i> Volver al Detalle de {{ tipo_entidad|capitalize }}
            </a>
        </li>
        <li>
            <a href="{{ url_for('main.index') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-home mr-2 w-4 text-center"></i> Volver al Dashboard Principal
            </a>
        </li>
        {% if reporte_html and not reporte_html.startswith("Error:") %}
        <li>
            <a href="{{ url_for('main.descargar_reporte_360_html', tipo_entidad=tipo_entidad, valor_codificado=nombre_entidad) }}"
               class="mt-3 block w-full text-left bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2.5 px-4 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:scale-105">
                <i class="fas fa-file-code mr-2"></i> Descargar Reporte (HTML)
            </a>
        </li>
        <li>
            <a href="{{ url_for('main.generar_plan_intervencion', tipo_entidad=tipo_entidad, valor_codificado=nombre_entidad) }}"
               class="mt-3 block w-full text-left bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:scale-105">
                <i class="fas fa-clipboard-list-check mr-2"></i> Generar Plan de Intervención
            </a>
        </li>
        {% endif %}
    </ul>
{% endblock panel_left_content %}

{% block panel_center_content %}
<div class="flex flex-col h-full">
    <div class="flex justify-between items-start mb-6">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800">
                Reporte 360: <span class="text-indigo-600">{{ nombre_entidad }}</span>
            </h1>
            <p class="text-lg font-normal text-slate-500">({{ tipo_entidad|capitalize }})</p>
        </div>
    </div>

    {% if reporte_html %}
        {% if reporte_html.startswith("Error:") %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                <p class="font-bold">Error al generar el reporte</p>
                <p>{{ reporte_html|safe }}</p>
            </div>
        {% else %}
            <div class="bg-white p-6 rounded-lg shadow-xl border border-slate-200 prose prose-sm max-w-none mb-8">
                {{ reporte_html|safe }}
            </div>

            {# --- INICIO: SECCIÓN DE REGISTRO DE OBSERVACIONES --- #}
            {% if reporte_360_id %}
            <div id="seccion-observaciones-reporte" class="my-8 p-6 bg-white rounded-lg shadow-xl border border-slate-200">
                <h2 class="text-xl font-semibold text-slate-800 mb-4">
                    <i class="fas fa-feather-alt mr-2 text-cyan-500"></i> Registro de Observaciones para este Reporte
                </h2>

                {# Formulario para nueva observación #}
                <form id="form-agregar-observacion-reporte" class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="hidden" id="reporte_360_id_obs" value="{{ reporte_360_id }}">
                    <input type="hidden" id="tipo_entidad_obs" value="{{ tipo_entidad }}">
                    <input type="hidden" id="nombre_entidad_obs" value="{{ nombre_entidad }}">
                    
                    <div class="mb-3">
                        <label for="observador_nombre" class="block text-sm font-medium text-slate-700 mb-1">Su Nombre (Observador):</label>
                        <input type="text" id="observador_nombre" name="observador_nombre" required
                               class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               placeholder="Ej: Juan Pérez, Psicopedagogo">
                    </div>
                    <div class="mb-3">
                        <label for="observacion_texto" class="block text-sm font-medium text-slate-700 mb-1">Observación / Intervención / Compromiso:</label>
                        <textarea id="observacion_texto" name="observacion_texto" rows="4" required
                                  class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                  placeholder="Describa la observación, intervención realizada, compromisos, etc."></textarea>
                    </div>
                    <div class="text-right">
                        <button type="submit"
                                class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-5 rounded-lg text-sm transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                            <i class="fas fa-plus-circle mr-1"></i> Guardar Observación
                        </button>
                    </div>
                </form>
                <div id="observacion-guardada-notificacion" class="text-xs mt-2 h-4"></div>

                {# Lista de observaciones existentes para este reporte #}
                <h3 class="text-lg font-medium text-slate-700 mt-6 mb-3">Observaciones Anteriores (para este Reporte #{{ reporte_360_id }}):</h3>
                <div id="lista-observaciones-reporte" class="space-y-3 max-h-80 overflow-y-auto custom-scrollbar border border-slate-200 rounded-md p-3 bg-slate-50">
                    {% if observaciones_reporte %}
                        {% for obs in observaciones_reporte %}
                            <div class="observacion-item pb-2 border-b border-slate-300 last:border-b-0">
                                <p class="text-xs text-slate-500 mb-1">
                                    <i class="far fa-calendar-alt mr-1"></i> {{ obs.timestamp }}
                                    <span class="mx-1">|</span>
                                    <i class="fas fa-user mr-1"></i> Por: <strong class="font-medium">{{ obs.observador_nombre }}</strong>
                                </p>
                                <div class="text-sm text-slate-700 prose prose-sm max-w-none">
                                    {{ obs.observacion_html|safe }}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-slate-500 italic">No hay observaciones registradas para este reporte todavía.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {# --- FIN: SECCIÓN DE REGISTRO DE OBSERVACIONES --- #}
        {% endif %}
    {% else %}
        <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 mb-6" role="alert">
            <p class="font-bold">Información no disponible</p>
            <p>No se pudo generar el contenido del reporte.</p>
        </div>
    {% endif %}
</div>
{% endblock panel_center_content %}

{% block panel_right_content %}
    {{ super() }}
{% endblock panel_right_content %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Página de Reporte 360 cargada.");
            const formAgregarObservacion = document.getElementById('form-agregar-observacion-reporte');
            const listaObservacionesDiv = document.getElementById('lista-observaciones-reporte');
            const notificacionDiv = document.getElementById('observacion-guardada-notificacion');

            if (formAgregarObservacion) {
                formAgregarObservacion.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const reporteId = document.getElementById('reporte_360_id_obs').value;
                    const observadorNombre = document.getElementById('observador_nombre').value.trim();
                    const observacionTexto = document.getElementById('observacion_texto').value.trim();
                    const tipoEntidad = document.getElementById('tipo_entidad_obs').value;
                    const nombreEntidad = document.getElementById('nombre_entidad_obs').value;

                    if (!reporteId || !observadorNombre || !observacionTexto || !tipoEntidad || !nombreEntidad) {
                        alert('Por favor, complete todos los campos: Nombre del observador y texto de la observación.');
                        return;
                    }

                    const payload = {
                        reporte_360_id: reporteId,
                        observador_nombre: observadorNombre,
                        observacion_texto: observacionTexto,
                        tipo_entidad: tipoEntidad,
                        nombre_entidad: nombreEntidad
                    };

                    const submitButton = formAgregarObservacion.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Guardando...';
                    if(notificacionDiv) notificacionDiv.textContent = '';


                    fetch("{{ url_for('main.api_add_observacion_reporte_360') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-plus-circle mr-1"></i> Guardar Observación';
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error || `Error del servidor: ${response.status}`) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        if (notificacionDiv) {
                            notificacionDiv.textContent = data.message || 'Observación guardada con éxito.';
                            notificacionDiv.className = 'text-xs mt-2 h-4 text-green-600';
                            setTimeout(() => { notificacionDiv.textContent = ''; }, 4000);
                        }
                        
                        document.getElementById('observacion_texto').value = '';
                        // Opcional: no limpiar el nombre del observador para facilitar múltiples registros
                        // document.getElementById('observador_nombre').value = ''; 

                        if (listaObservacionesDiv && data.observaciones) {
                            renderObservaciones(data.observaciones);
                        }
                    })
                    .catch(error => {
                        console.error('Error al guardar observación:', error);
                        if (notificacionDiv) {
                            notificacionDiv.textContent = `Error: ${error.message}`;
                            notificacionDiv.className = 'text-xs mt-2 h-4 text-red-600';
                        }
                    });
                });
            }

            function renderObservaciones(observaciones) {
                if (!listaObservacionesDiv) return;
                listaObservacionesDiv.innerHTML = ''; 

                if (observaciones && observaciones.length > 0) {
                    observaciones.forEach(obs => {
                        const obsItemDiv = document.createElement('div');
                        obsItemDiv.className = 'observacion-item pb-2 border-b border-slate-300 last:border-b-0';
                        
                        const metaP = document.createElement('p');
                        metaP.className = 'text-xs text-slate-500 mb-1';
                        metaP.innerHTML = `
                            <i class="far fa-calendar-alt mr-1"></i> ${obs.timestamp}
                            <span class="mx-1">|</span>
                            <i class="fas fa-user mr-1"></i> Por: <strong class="font-medium">${escapeHtml(obs.observador_nombre)}</strong>
                        `;
                        
                        const textoDiv = document.createElement('div');
                        textoDiv.className = 'text-sm text-slate-700 prose prose-sm max-w-none';
                        textoDiv.innerHTML = obs.observacion_html; 

                        obsItemDiv.appendChild(metaP);
                        obsItemDiv.appendChild(textoDiv);
                        listaObservacionesDiv.appendChild(obsItemDiv);
                    });
                } else {
                    listaObservacionesDiv.innerHTML = '<p class="text-sm text-slate-500 italic">No hay observaciones registradas para este reporte todavía.</p>';
                }
            }
            
            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return '';
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }
        });
    </script>
{% endblock scripts %}
