<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Título por Defecto{% endblock %} - TutorIA360 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
        }
        html { scroll-behavior: smooth; }
        #panel_left, #panel_center, #panel_right {
            height: calc(100vh - 10rem); /* 5rem header + 5rem footer aprox. Ajustar según altura real del footer/header */
            overflow-y: auto; 
        }
        .placeholder-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e2e8f0; 
            color: #475569; 
            font-weight: bold;
            border-radius: 0.25rem; 
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
    {% block head_extra %}{% endblock %}
</head>
<body class="bg-slate-100 text-slate-700 antialiased">

    <header class="bg-white shadow-lg sticky top-0 z-50 w-full h-20 flex-shrink-0">
        <nav class="container mx-auto px-6 h-full flex justify-between items-center">
            <div class="flex items-center">
                <a href="{{ url_for('main.index') }}" class="flex items-center group">
                   {# Asumiendo que 'main.static' es correcto para tu logo, o cambiar a 'static' si es global #}
                   <img src="{{ url_for('static', filename='images/logo1.png') }}" alt="Logo TutorIA360"
                        class="h-12 md:h-14 w-auto mr-3 rounded transition-transform duration-300 ease-in-out group-hover:scale-105"
                        onerror="this.outerHTML='<div class=\'placeholder-fallback h-12 md:h-14 w-auto mr-3\'>Logo</div>'">
                   <span class="text-2xl md:text-3xl font-extrabold text-teal-700 group-hover:text-teal-600 transition-colors duration-300">
                       TutorIA<span class="text-teal-500">360</span>
                   </span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="#" title="Acceso Usuarios" class="text-slate-600 hover:text-teal-600 transition duration-300 ease-in-out transform hover:scale-110">
                    <i class="fas fa-user-circle text-2xl"></i>
                </a>
            </div>
        </nav>
    </header>

    <div class="w-full z-40 flex-shrink-0">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="container mx-auto px-6 pt-4">
                    {% for category, message in messages %}
                        {% set alert_classes = 'p-4 mb-4 rounded-md border text-sm' %}
                        {% if category == 'danger' %}
                            {% set alert_classes = alert_classes + ' bg-red-100 border-red-400 text-red-700' %}
                        {% elif category == 'success' %}
                            {% set alert_classes = alert_classes + ' bg-green-100 border-green-400 text-green-700' %}
                        {% elif category == 'warning' %}
                            {% set alert_classes = alert_classes + ' bg-yellow-100 border-yellow-400 text-yellow-700' %}
                        {% else %}
                            {% set alert_classes = alert_classes + ' bg-blue-100 border-blue-400 text-blue-700' %}
                        {% endif %}
                        <div class="{{ alert_classes }}" role="alert">
                            {% if category == 'danger' %}<i class="fas fa-times-circle mr-2"></i>
                            {% elif category == 'success' %}<i class="fas fa-check-circle mr-2"></i>
                            {% elif category == 'warning' %}<i class="fas fa-exclamation-triangle mr-2"></i>
                            {% else %}<i class="fas fa-info-circle mr-2"></i>
                            {% endif %}
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
    </div>

    <main id="main-dashboard-container" class="flex flex-1 w-full">

<aside id="panel_left" class="w-64 bg-slate-50 p-4 border-r border-slate-200 shadow-sm custom-scrollbar flex-shrink-0">
    {% block panel_left_content %}
        {# Contenido por defecto del panel izquierdo si no se sobrescribe en otra plantilla #}
        <h2 class="text-lg font-semibold text-slate-700 mb-4">Panel Izquierdo (Base)</h2>
        <div class="placeholder-content h-32 border-2 border-dashed border-slate-300 rounded-md p-4 text-slate-400 flex items-center justify-center">
            Contenido Izquierdo (Base)
        </div>
    {% endblock panel_left_content %}

    {% if session.consumo_sesion is defined %}
    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200 my-6">
        <h3 class="text-md font-semibold text-slate-700 mb-2">Consumo de la Sesión</h3>
        <div class="text-sm space-y-1 text-slate-600">
            <div class="flex justify-between items-center">
                <span><i class="fas fa-coins fa-fw mr-2 text-yellow-500"></i>Total Tokens:</span>
                <strong id="session-total-tokens" class="font-mono text-slate-800">{{ session.consumo_sesion.total_tokens|int }}</strong>
            </div>
            <div class="flex justify-between items-center">
                <span><i class="fas fa-dollar-sign fa-fw mr-2 text-green-500"></i>Costo Estimado:</span>
                <strong id="session-total-cost" class="font-mono text-slate-800">US$ {{ "{:,.6f}".format(session.consumo_sesion.total_cost) }}</strong>
            </div>
        </div>
    </div>
    {% endif %}
    {# --- FORMULARIO PARA SUBIR PDF DE CONTEXTO --- #}
    <hr class="my-6 border-slate-300">
    <h3 class="text-md font-semibold text-slate-700 mb-3">Documentos de Contexto</h3>
    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200">
        <form action="{{ url_for('main.upload_context_pdf') }}" method="post" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="context_pdf_file" class="block text-sm font-medium text-slate-700 mb-1">
                    Seleccionar PDF:
                </label>
                <input type="file" id="context_pdf_file" name="context_pdf_file" accept=".pdf" required
                       class="block w-full text-xs text-slate-500 border border-slate-300 rounded-lg cursor-pointer
                              file:mr-2 file:py-1.5 file:px-3
                              file:rounded-md file:border-0
                              file:text-xs file:font-semibold
                              file:bg-sky-50 file:text-sky-700
                              hover:file:bg-sky-100 focus:outline-none focus:ring-1 focus:ring-offset-1 focus:ring-sky-500">
                <p class="mt-1 text-xs text-slate-500">Solo archivos .pdf.</p>
            </div>
            <button type="submit"
                    class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                <i class="fas fa-upload mr-1"></i> Subir Documento PDF
            </button>
        </form>
    </div>
</aside>

        <section id="panel_center" class="flex-grow bg-white p-6 custom-scrollbar">
            {% block panel_center_content %}
                 <h2 class="text-lg font-semibold text-slate-700 mb-4">Panel Central (Base)</h2>
                <div class="placeholder-content h-64 border-2 border-dashed border-slate-300 rounded-md p-4 text-slate-400 flex items-center justify-center">
                    Contenido Central (Base)
                </div>
            {% endblock panel_center_content %}
        </section>

        <aside id="panel_right" class="w-80 bg-slate-50 p-4 border-l border-slate-200 shadow-sm custom-scrollbar flex-shrink-0">
    {% block panel_right_content %}
        <h2 class="text-xl font-semibold text-slate-800 mb-6">Búsqueda Rápida</h2>
        <div id="quick-search-container" class="space-y-6 bg-white p-6 rounded-lg shadow-md border border-slate-200">
            <div>
                <label for="search_student_input_live" class="block text-sm font-medium text-slate-700 mb-1">Buscar Estudiante:</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-user text-slate-400"></i>
                    </div>
                    <input type="text" name="search_student_input_live" id="search_student_input_live"
                           class="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                           placeholder="Nombre o Apellido (mín. 2 letras)..." autocomplete="off">
                </div>
                <div id="student_suggestions_output" class="mt-1 border border-gray-300 rounded-md bg-white max-h-48 overflow-y-auto z-20 shadow-lg" style="display: none;">
                    {# Contenido se carga vía JS #}
                </div>
            </div>
            <div>
                <label for="search_course_input_filter" class="block text-sm font-medium text-slate-700 mb-1">Filtrar Curso en Lista:</label>
                 <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-filter text-slate-400"></i>
                    </div>
                    <input type="text" name="search_course_input_filter" id="search_course_input_filter"
                           class="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                           placeholder="Escribe para filtrar cursos...">
                </div>
                <label for="course_select_dropdown" class="block text-sm font-medium text-slate-700 mt-3 mb-1">Seleccionar Curso de la Lista:</label>
                <select name="course_select_dropdown" id="course_select_dropdown"
                        class="w-full pl-3 pr-10 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm custom-scrollbar">
                    <option value="">Cargando cursos...</option>
                    {# Opciones se cargan vía JS #}
                </select>
            </div>
            <button type="button" id="apply_quick_search_button"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-search mr-2"></i> Aplicar Filtros/Búsqueda
            </button>
            <a href="#" id="go_to_detail_dashboard_button"
               class="mt-3 w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 text-center hidden items-center justify-center">
                 <i class="fas fa-chart-pie mr-2"></i> <span id="go_to_detail_dashboard_button_text">Ir al panel...</span>
            </a>
        </div>
        {% if session.uploaded_filename %}
        <div class="mt-6 text-xs text-slate-500 text-center">
            <p>Búsquedas y listados basados en: <strong class="font-medium">{{ session.uploaded_filename }}</strong>.</p>
        </div>
        {% else %}
        <div class="mt-6 text-xs text-slate-500 text-center">
            <p>Carga un archivo CSV para activar la búsqueda rápida.</p>
        </div>
        {% endif %}
    {% endblock panel_right_content %}
</aside>
    </main>

    <footer class="bg-slate-800 text-slate-400 py-5 w-full h-20 flex-shrink-0">
         <div class="container mx-auto px-6 text-center flex items-center justify-center h-full">
            <p class="text-sm">&copy; {{ current_year }} TutorIA360. Todos los derechos reservados.</p>
         </div>
    </footer>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Elementos del DOM ---
    const studentInput = document.getElementById('search_student_input_live');
    const studentSuggestionsOutput = document.getElementById('student_suggestions_output');
    const courseFilterInput = document.getElementById('search_course_input_filter');
    const courseSelectDropdown = document.getElementById('course_select_dropdown');
    const applySearchButton = document.getElementById('apply_quick_search_button');
    const goToDetailDashboardButton = document.getElementById('go_to_detail_dashboard_button');
    const goToDetailDashboardButtonText = document.getElementById('go_to_detail_dashboard_button_text');

    let studentSearchDebounceTimer;
    let selectedStudentName = '';
    let selectedCourseName = '';

    function highlightMatch(text, term) {
        if (!term || !text) return text;
        const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        try {
            const regex = new RegExp(`(${escapedTerm})`, 'gi');
            return text.replace(regex, '<strong class="font-bold text-indigo-600">$1</strong>');
        } catch (e) {
            console.error("Error creating RegExp in highlightMatch:", e);
            return text;
        }
    }

    function loadCourses() {
        if (!courseSelectDropdown) {
            console.warn("Dropdown de cursos no encontrado en el DOM.");
            return;
        }
        {% if session.uploaded_filename %}
            fetch("{{ url_for('main.api_get_courses') }}") // Usar url_for para la ruta API
                .then(response => {
                    if (!response.ok) { throw new Error(`Error del servidor: ${response.status} ${response.statusText}`); }
                    return response.json();
                })
                .then(data => {
                    courseSelectDropdown.innerHTML = '<option value="">-- Todos los Cursos --</option>';
                    if (data && Array.isArray(data)) {
                        if (data.length > 0) {
                            data.forEach(courseName => {
                                if (courseName !== null && courseName !== undefined) {
                                    const option = document.createElement('option');
                                    option.value = courseName;
                                    option.textContent = courseName;
                                    courseSelectDropdown.appendChild(option);
                                }
                            });
                        } else {
                            const noCoursesOpt = document.createElement('option');
                            noCoursesOpt.textContent = 'No hay cursos en el archivo';
                            noCoursesOpt.disabled = true;
                            courseSelectDropdown.appendChild(noCoursesOpt);
                        }
                    } else if (data && data.error) {
                        console.error("Error cargando cursos (API):", data.error);
                        courseSelectDropdown.innerHTML = `<option value="" disabled selected>Error API: ${data.error}</option>`;
                    } else {
                         console.error("Respuesta inesperada de {{ url_for('main.api_get_courses') }}:", data);
                         courseSelectDropdown.innerHTML = '<option value="" disabled selected>Error respuesta API</option>';
                    }
                })
                .catch(error => {
                    console.error('Error crítico al cargar cursos (fetch):', error);
                    courseSelectDropdown.innerHTML = `<option value="" disabled selected>Error de red al cargar cursos</option>`;
                });
        {% else %}
            courseSelectDropdown.innerHTML = '<option value="" disabled selected>Cargue un archivo CSV</option>';
        {% endif %}
    }

    if (studentInput && studentSuggestionsOutput) {
        studentInput.addEventListener('input', function() {
            clearTimeout(studentSearchDebounceTimer);
            const searchTerm = this.value.trim();

            if (selectedCourseName) { 
                selectedCourseName = '';
                if(courseSelectDropdown) courseSelectDropdown.value = '';
                console.log("DEBUG: Selección de curso limpiada por input de estudiante.");
            }
            if (goToDetailDashboardButton) goToDetailDashboardButton.classList.add('hidden');

            if (searchTerm.length < 2) {
                studentSuggestionsOutput.innerHTML = '';
                studentSuggestionsOutput.style.display = 'none';
                if (selectedStudentName) { 
                    selectedStudentName = ''; 
                    console.log("DEBUG: selectedStudentName limpiado (término corto).");
                }
                return;
            }
            studentSuggestionsOutput.style.display = 'block';
            studentSuggestionsOutput.innerHTML = '<div class="p-2 text-sm text-slate-500">Buscando...</div>';
            
            studentSearchDebounceTimer = setTimeout(() => {
                fetch(`{{ url_for('main.api_search_students') }}?term=${encodeURIComponent(searchTerm)}`) // Usar url_for
                    .then(response => {
                        if (!response.ok) { throw new Error(`Error del servidor: ${response.status} ${response.statusText}`); }
                        return response.json();
                    })
                    .then(data => {
                        studentSuggestionsOutput.innerHTML = '';
                        if (data && Array.isArray(data) && data.length > 0) {
                            data.forEach(studentName => {
                                 if (studentName !== null && studentName !== undefined) {
                                    const suggestionDiv = document.createElement('div');
                                    suggestionDiv.classList.add('p-2', 'text-sm', 'cursor-pointer', 'hover:bg-indigo-50', 'border-b', 'border-gray-200', 'last:border-b-0');
                                    suggestionDiv.innerHTML = highlightMatch(String(studentName), searchTerm);
                                    suggestionDiv.addEventListener('click', function() {
                                        studentInput.value = studentName;
                                        selectedStudentName = studentName;
                                        selectedCourseName = ''; 
                                        if(courseSelectDropdown) courseSelectDropdown.value = '';
                                        studentSuggestionsOutput.style.display = 'none';
                                        console.log('DEBUG: Estudiante seleccionado de sugerencia:', studentName);
                                        if (goToDetailDashboardButton) goToDetailDashboardButton.classList.add('hidden');
                                    });
                                    studentSuggestionsOutput.appendChild(suggestionDiv);
                                }
                            });
                        } else {
                            studentSuggestionsOutput.innerHTML = '<div class="p-2 text-sm text-slate-500">No se encontraron estudiantes.</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error en búsqueda de estudiantes (fetch):', error);
                        studentSuggestionsOutput.innerHTML = `<div class="p-2 text-sm text-red-500">Error al buscar: ${error.message}.</div>`;
                    });
            }, 350);
        });

        document.addEventListener('click', function(event) {
            if (studentInput && studentSuggestionsOutput && !studentInput.contains(event.target) && !studentSuggestionsOutput.contains(event.target)) {
                studentSuggestionsOutput.style.display = 'none';
            }
        });
    }

    if (courseFilterInput && courseSelectDropdown) {
        courseFilterInput.addEventListener('input', function() {
            const filterValue = this.value.toLowerCase();
            Array.from(courseSelectDropdown.options).forEach(option => {
                const optionText = option.text.toLowerCase();
                option.style.display = (option.value === "" || optionText.includes(filterValue)) ? "" : "none";
            });
            if (courseSelectDropdown.options[courseSelectDropdown.selectedIndex]?.style.display === 'none') {
                courseSelectDropdown.value = "";
                if (selectedCourseName) {
                    selectedCourseName = '';
                    console.log("DEBUG: selectedCourseName limpiado por filtro.");
                    if (goToDetailDashboardButton) goToDetailDashboardButton.classList.add('hidden');
                }
            }
        });

        courseSelectDropdown.addEventListener('change', function() {
            selectedCourseName = this.value;
            if (this.value) {
                if (selectedStudentName) { 
                    selectedStudentName = '';
                    if(studentInput) studentInput.value = '';
                    console.log("DEBUG: Selección de estudiante limpiada por selección de curso.");
                }
                console.log('DEBUG: Curso seleccionado del dropdown:', this.value);
            } else {
                console.log("DEBUG: Selección de curso reseteada (opción '-- Todos los Cursos --').");
            }
            if (goToDetailDashboardButton) goToDetailDashboardButton.classList.add('hidden');
        });
    }

    if (applySearchButton && goToDetailDashboardButton && goToDetailDashboardButtonText) {
        applySearchButton.addEventListener('click', function() {
            const studentForDetail = selectedStudentName; 
            const courseForDetail = selectedCourseName;

            console.log('--- DEBUG: Click en "Aplicar Filtros/Búsqueda" ---');
            console.log('DEBUG: Valor de selectedStudentName:', `"${studentForDetail}"`);
            console.log('DEBUG: Valor de selectedCourseName:', `"${courseForDetail}"`);

            if (studentForDetail && !courseForDetail) {
                console.log('DEBUG: Condición: Solo estudiante seleccionado.');
                // Usar url_for para construir la URL base y luego añadir el parámetro dinámico
                const baseUrl = "{{ url_for('main.detalle_entidad', tipo='alumno', valor_codificado='__VALOR__') }}";
                const url = baseUrl.replace('__VALOR__', encodeURIComponent(studentForDetail));
                goToDetailDashboardButton.href = url;
                goToDetailDashboardButtonText.textContent = `Ir al panel de ${studentForDetail}`;
                goToDetailDashboardButton.classList.remove('hidden');
                goToDetailDashboardButton.style.display = 'flex';
                console.log('DEBUG: Botón de detalle para ALUMNO mostrado. URL:', url);
            } else if (!studentForDetail && courseForDetail) {
                console.log('DEBUG: Condición: Solo curso seleccionado.');
                const baseUrl = "{{ url_for('main.detalle_entidad', tipo='curso', valor_codificado='__VALOR__') }}";
                const url = baseUrl.replace('__VALOR__', encodeURIComponent(courseForDetail));
                goToDetailDashboardButton.href = url;
                goToDetailDashboardButtonText.textContent = `Ir al panel de ${courseForDetail}`;
                goToDetailDashboardButton.classList.remove('hidden');
                goToDetailDashboardButton.style.display = 'flex';
                console.log('DEBUG: Botón de detalle para CURSO mostrado. URL:', url);
            } else if (studentForDetail && courseForDetail) {
                console.log('DEBUG: Condición: Ambos seleccionados (esto no debería ocurrir).');
                alert('Por favor, seleccione solo un estudiante O un curso para ver el detalle.');
                goToDetailDashboardButton.classList.add('hidden');
            } else {
                console.log('DEBUG: Condición: Ninguno seleccionado.');
                alert('Por favor, seleccione un estudiante o un curso de las listas para ver el detalle.');
                goToDetailDashboardButton.classList.add('hidden');
            }
            console.log('--- FIN DEBUG ---');
        });
    } else {
        console.warn("Uno o más elementos de botón no fueron encontrados: applySearchButton, goToDetailDashboardButton, goToDetailDashboardButtonText.");
    }

    loadCourses(); // Cargar cursos al iniciar la página
});
</script>
{% endblock scripts %}

</body>
</html>
